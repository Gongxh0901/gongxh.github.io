---
layout: post
title: "ecsæ¶æ„"
date: 2024-01-08 15:00:00 +0800
categories: ["å¼€æºé¡¹ç›®"]
tags: ["ECS", "TypeScript", "æ¸¸æˆå¼•æ“", "å¼€æº", "Cocos Creator"]
excerpt: "kunpocc-ecsæ˜¯ä¸€ä¸ªç”¨TypeScriptå®ç°çš„é«˜æ€§èƒ½Entity-Component-Systemæ¶æ„æ¡†æ¶ï¼Œä¸ºæ¸¸æˆå¼€å‘å’Œå¤§è§„æ¨¡å®æ—¶æ¨¡æ‹Ÿæä¾›ä¼˜åŒ–è§£å†³æ–¹æ¡ˆã€‚"
---

# kunpocc-ecs - é«˜æ€§èƒ½å®ä½“ç»„ä»¶ç³»ç»Ÿæ¡†æ¶

kunpocc-ecsæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½å®ä½“ç»„ä»¶ç³»ç»Ÿ (Entity-Component-System) æ¡†æ¶ï¼Œä¸“ä¸ºæ¸¸æˆå¼€å‘å’Œå¤§è§„æ¨¡å®æ—¶æ¨¡æ‹Ÿè®¾è®¡ï¼Œä½¿ç”¨TypeScriptç¼–å†™ï¼Œæä¾›å®Œæ•´çš„ECSæ¶æ„è§£å†³æ–¹æ¡ˆã€‚

## é¡¹ç›®ç‰¹è‰²

### ğŸš€ é«˜æ€§èƒ½è®¾è®¡
- **ä¼˜åŒ–çš„æ•°æ®ç»“æ„å’Œç®—æ³•**ï¼šæ”¯æŒå¤„ç†å¤§é‡å®ä½“
- **å†…å­˜é«˜æ•ˆ**ï¼šä½¿ç”¨å¯¹è±¡æ± å’Œå¯†é›†æ•°æ®ç»“æ„å‡å°‘å†…å­˜å¼€é”€å’ŒGCå‹åŠ›
- **ç¨€ç–é›†åˆ + å¯†é›†æ•°ç»„**ï¼šä¼˜ç§€çš„é¢‘ç¹æ·»åŠ åˆ é™¤æ€§èƒ½
- **æ©ç é«˜æ•ˆåŒ¹é…**ï¼šå¿«é€Ÿçš„å®ä½“æŸ¥è¯¢ç³»ç»Ÿ

### ğŸ› ï¸ å¼€å‘ä½“éªŒ
- **ç®€æ´API**ï¼šç›´è§‚æ˜“ç”¨çš„æ¥å£è®¾è®¡ï¼Œé™ä½å­¦ä¹ æˆæœ¬
- **å®Œæ•´ç±»å‹æ”¯æŒ**ï¼šä½¿ç”¨TypeScriptæ„å»ºï¼Œæä¾›å…¨é¢çš„ç±»å‹å®‰å…¨
- **è£…é¥°å™¨æ”¯æŒ**ï¼šä½¿ç”¨è£…é¥°å™¨æ ‡è®°ç»„ä»¶å’Œç³»ç»Ÿ
- **æ•°æ®ç¼–è¾‘å™¨**ï¼šæä¾›Cocos Creatoræ’ä»¶æ”¯æŒ

### ğŸ® æ¸¸æˆå¼€å‘ä¸“ç”¨
- **Cocos Creatoré›†æˆ**ï¼šä¸“é—¨ä¸ºCocos Creatorå¼€å‘ä¼˜åŒ–
- **ç¼–è¾‘å™¨æ”¯æŒ**ï¼š[å•†åº—æ’ä»¶](https://store.cocos.com/app/detail/7311)ï¼Œæ”¯æŒCreator 3.7.0åŠä»¥åç‰ˆæœ¬
- **å¯è§†åŒ–ç¼–è¾‘**ï¼šåŸºäºCreator 3.8.6å¼€å‘çš„æ•°æ®ç¼–è¾‘å™¨

## å®‰è£…

```bash
npm install kunpocc-esc
```

## æ ¸å¿ƒæ¦‚å¿µ

- **å®ä½“(Entity)**ï¼šæ¸¸æˆå¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¯æ•°å­—çš„ID
- **ç»„ä»¶(Component)**ï¼šçº¯æ•°æ®ç»“æ„ï¼Œé™„åŠ åˆ°å®ä½“ä¸Šï¼Œæè¿°å®ä½“ç‰¹æ€§
- **ç³»ç»Ÿ(System)**ï¼šåŒ…å«æ¸¸æˆé€»è¾‘ï¼Œå¤„ç†æ‹¥æœ‰ç‰¹å®šç»„ä»¶ç»„åˆçš„å®ä½“
- **ä¸–ç•Œ(World)**ï¼šç®¡ç†æ‰€æœ‰å®ä½“ã€ç»„ä»¶å’Œç³»ç»Ÿçš„å®¹å™¨

## åŸºæœ¬ä½¿ç”¨

### 1. å®šä¹‰ç»„ä»¶

ä½¿ç”¨è£…é¥°å™¨æ ‡è®°çš„å±æ€§æ‰èƒ½è¢« **kunpo-ec** æ’ä»¶æ£€æµ‹åˆ°ï¼š

```typescript
import { _ecsdecorator, Component } from 'kunpocc-esc';
const { ecsclass, ecsprop } = _ecsdecorator;

// å®šä¹‰ä½ç½®ç»„ä»¶
@ecsclass("Position")
class Position extends Component {
    // ä½¿ç”¨è£…é¥°å™¨æ ‡è®°çš„å±æ€§æ‰èƒ½è¢« kunpoec æ’ä»¶æ£€æµ‹åˆ°
    @ecsprop({ type: "int", defaultValue: 0 })
    public x: number = 0;

    @ecsprop({ type: "int", defaultValue: 0 })
    public y: number = 0;
    
    // å¿…é¡»å®ç°resetæ–¹æ³•ç”¨äºå¯¹è±¡æ± å›æ”¶æ—¶é‡ç½®æ•°æ®
    public reset(): void {
        this.x = 0;
        this.y = 0;
    }
}

// å®šä¹‰é€Ÿåº¦ç»„ä»¶
@ecsclass("Velocity")
class Velocity extends Component {
    vx: number = 0;
    vy: number = 0;
    
    reset(): void {
        this.vx = 0;
        this.vy = 0;
    }
}
```

### 2. å®šä¹‰ç³»ç»Ÿ

ç³»ç»Ÿä¹Ÿéœ€è¦ä½¿ç”¨è£…é¥°å™¨æ ‡è®°ï¼š

```typescript
import { System, _ecsdecorator } from 'kunpocc-esc';
const { ecsystem } = _ecsdecorator;

@ecsystem("MovementSystem", { describe: "å¤„ç†å®ä½“ç§»åŠ¨çš„ç³»ç»Ÿ" })
class MovementSystem extends System {
    // é…ç½®æŸ¥è¯¢è§„åˆ™
    protected onInit(): void {
        // è¿™ä¸ªè§„åˆ™çš„å«ä¹‰æ˜¯
        // å¿…é¡»åŒ…å« Positionã€Speedå’ŒDirection ä¸‰ç§å®ä½“
        // å¹¶ä¸”åŒ…å« Component1å’ŒComponent2ä¸­çš„ä»»æ„ä¸€ä¸ª
        // å¹¶ä¸”å¿…é¡»ä¸åŒ…å«Component3
        // Component4æ˜¯å¯é€‰çš„ ç­›é€‰ç»„ä»¶æ—¶ä¼šæŠŠåŒ¹é…åˆ°çš„å®ä½“ä¸Šçš„Component4ç»„ä»¶ä¹ŸæŸ¥å‡ºæ¥
        // å¦‚æœæ²¡æœ‰å°±ç»™ä¸ªnullå€¼
        this.matcher.allOf(Position, Speed, Direction)
                   .anyOf(Component1, Component2)
                   .excludeOf(Component3)
                   .optionalOf(Component4);
    }
  
    // æ›´æ–°
    update(dt: number): void {
        const query = this.query;
        for (const [entity, position, speed, direction] of query.iterate3(Position, Speed, Direction)) {
            position.x += direction.x * speed.speed * dt;
            position.y += direction.y * speed.speed * dt;
        }
    }
}
```

### 3. åˆ›å»ºä¸–ç•Œå’Œé…ç½®ç³»ç»Ÿ

```typescript
import { World } from 'kunpocc-esc';

// ç¬¬1æ­¥ï¼šåˆ›å»ºä¸–ç•Œå®ä¾‹
// å‚æ•°1: ä¸–ç•Œåç§°
// å‚æ•°2: æœ€å¤§å®ä½“æ•°é‡ æ ¹æ®æ¸¸æˆè§„æ¨¡åˆ†é…ä¸€ä¸ªå°½é‡å°çš„å€¼ (æœ€å¥½æ˜¯2çš„æŒ‡æ•°)
const world = new World("GameWorld", 2 >> 16);

// ç¬¬2æ­¥ï¼šæ³¨å†Œç³»ç»Ÿ

// ç³»ç»Ÿç»„
// å‚æ•°1: ç»„å
// å‚æ•°2: å¸§é—´éš”ï¼ˆå¯å¯¹ä¸éœ€è¦æ¯å¸§æ›´æ–°çš„ç³»ç»Ÿç»„æ·»åŠ å¸§é—´éš” 3è¡¨ç¤ºæ¯3å¸§æ›´æ–°ä¸€æ¬¡ï¼‰
let group1 = new ecs.SystemGroup("ç³»ç»Ÿç»„1", 3);
group1
    .addSystem(new System1())
    .addSystem(new System2())
    .addSystem(new System3());

// æ·»åŠ ç³»ç»Ÿå’Œç³»ç»Ÿç»„
world.addSystem(new System4())
     .addSystem(group1)
     .addSystem(new System5());

// ç¬¬3æ­¥ï¼šåˆå§‹åŒ–ä¸–ç•Œ (å¿…é¡»è°ƒç”¨)
world.initialize();

// ç¬¬4æ­¥ï¼šåœ¨æ¸¸æˆå¾ªç¯ä¸­æ›´æ–°ä¸–ç•Œ å¹¶ä¼ å…¥å¸§é—´éš”
world.update(dt);
```

### 4. å®ä½“å’Œç»„ä»¶ç®¡ç†

#### æ–¹å¼1: åˆ›å»ºç©ºå®ä½“ï¼Œæ‰‹åŠ¨æ·»åŠ ç»„ä»¶
```typescript
// åˆ›å»ºå®ä½“ - ç©ºå®ä½“åªæœ‰ID
const entity = world.createEmptyEntity();

// æ·»åŠ ç»„ä»¶
const position = world.addComponent(entity, Position);
position.x = 10;
position.y = 20;

const velocity = world.addComponent(entity, Velocity);
velocity.vx = 1;
velocity.vy = 2;
```

#### æ–¹å¼2: é€šè¿‡é…ç½®æ•°æ®åˆ›å»ºå®ä½“
```typescript
// é€šè¿‡é…ç½®åˆ›å»ºå®ä½“
// æ•°æ®é…ç½®ä½¿ç”¨creatorå•†åº—ä¸­çš„æ’ä»¶ kunpoec é…ç½®
// æ’ä»¶ç‰ˆæœ¬1.0.3å¼€å§‹æ”¯æŒå¯¼å‡º ecsä½¿ç”¨çš„æ•°æ®
world.createEntity("Entity1");
```

## é«˜çº§ç‰¹æ€§

### æŸ¥è¯¢å™¨ç³»ç»Ÿ

æŸ¥è¯¢ç»“æœæä¾›3ç§æ–¹å¼è·å–ï¼š

#### 1. ç›´æ¥è·å–åŒ¹é…å®ä½“çš„é›†åˆ
```typescript
this.query.entitys
```

#### 2. é€šç”¨è¿­ä»£å™¨ï¼Œæœ€å¤šåŒæ—¶è·å–8ç§ç±»å‹çš„ç»„ä»¶ï¼Œæå°‘é‡GC
```typescript
for (const [entity, position, speed, direction] of query.iterate(Position, Speed, Direction)) {
    position.x += speed.speed * dt;
    position.y += speed.speed * dt;
    console.log("direction", direction);
}
```

#### 3. ç‰¹å®šæ•°é‡è¿­ä»£å™¨ï¼ˆ1/2/3/4ï¼‰ï¼Œé›¶GC
```typescript
// å•ç»„ä»¶è¿­ä»£
for (const [entity, position] of query.iterate1(Position)) {
    console.log(position.x, position.y);
}

// åŒç»„ä»¶è¿­ä»£
for (const [entity, position, speed] of query.iterate2(Position, Speed)) {
    // å¤„ç†é€»è¾‘
}

// ä¸‰ç»„ä»¶è¿­ä»£
for (const [entity, position, speed, direction] of query.iterate3(Position, Speed, Direction)) {
    // å¤„ç†é€»è¾‘
}

// å››ç»„ä»¶è¿­ä»£
for (const [entity, position, speed, direction, scale] of query.iterate4(Position, Speed, Direction, Scale)) {
    // å¤„ç†é€»è¾‘
}
```

### å‘½ä»¤ç¼“å†²åŒº

Kunpocc-ECSä½¿ç”¨å‘½ä»¤ç¼“å†²æ¨¡å¼ç®¡ç†å®ä½“å’Œç»„ä»¶å˜æ›´ï¼Œé¿å…è¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹æ•°æ®ç»“æ„å¯¼è‡´é”™è¯¯ã€‚åˆ é™¤å®ä½“ã€åˆ é™¤ç»„ä»¶ã€æ·»åŠ ç»„ä»¶ç­‰æ“ä½œä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§çš„updateå‰å¤„ç†ï¼š

```typescript
// åˆ é™¤å®ä½“(ä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§çš„updateå‰å¤„ç†)
world.removeEntity(entity);

// æ·»åŠ ç»„ä»¶(ä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§çš„updateå‰å¤„ç†)
world.addComponent(entity, Position);

// åˆ é™¤ç»„ä»¶(ä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§çš„updateå‰å¤„ç†)
world.removeComponent(entity, Position);
```

## æ€§èƒ½åˆ†æ

### æ•°æ®å¸ƒå±€æ–¹å¼ï¼šç¨€ç–é›†åˆ + å¯†é›†æ•°ç»„

- **ä¼˜ç§€**ï¼šé¢‘ç¹æ·»åŠ åˆ é™¤å®ä½“
- **ä¼˜ç§€**ï¼šé¢‘ç¹æ·»åŠ å’Œåˆ é™¤ç»„ä»¶
- **è‰¯å¥½**ï¼šç³»ç»Ÿéå†
- **è¾ƒå·®**ï¼šå†…å­˜å ç”¨ï¼ˆç›¸å¯¹äºå…¶ä»–å¸ƒå±€æ–¹å¼ï¼‰

### æ•°æ®å¸ƒå±€ç‰¹ç‚¹

- **å¯†é›†å­˜å‚¨**ï¼šæŒ‰ç»„ä»¶ç±»å‹å­˜å‚¨ç»„ä»¶æ•°æ®
- **ç¨€ç–é›†åˆ**ï¼šå®ä½“åˆ°ç»„ä»¶ç´¢å¼•

### æŸ¥è¯¢å™¨ä¼˜åŒ–

- **æ¡ä»¶ç›¸åŒæ—¶å¤ç”¨**ï¼šç›¸åŒæŸ¥è¯¢æ¡ä»¶å…±äº«æŸ¥è¯¢å™¨å®ä¾‹
- **å¤šæ¬¡è·å–æŸ¥è¯¢ç»“æœæ— æ¶ˆè€—**ï¼šç¼“å­˜æŸ¥è¯¢ç»“æœ

## é¡¹ç›®é“¾æ¥

- **GitHub**: [https://github.com/gongxh0901/kunpo-ecs](https://github.com/gongxh0901/kunpo-ecs)
- **Cocos Store**: [æ•°æ®ç¼–è¾‘å™¨æ’ä»¶](https://store.cocos.com/app/detail/7311)
- **Stars**: 16+ GitHub Stars
- **åŒ…å**: kunpocc-esc

## æŠ€æœ¯ç‰¹ç‚¹

- **TypeScript 96.7%**ï¼šä¸»è¦ä½¿ç”¨TypeScriptå¼€å‘
- **æ”¯æŒç‰ˆæœ¬**ï¼šCocos Creator 3.7.0åŠä»¥åç‰ˆæœ¬
- **ç¼–è¾‘å™¨æ”¯æŒ**ï¼šåŸºäºCreator 3.8.6å¼€å‘çš„æ•°æ®ç¼–è¾‘å™¨
- **é›¶åˆ†é…ä¼˜åŒ–**ï¼šç‰¹å®šè¿­ä»£å™¨å®ç°é›¶GCè®¾è®¡

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤é—®é¢˜å’Œåˆå¹¶è¯·æ±‚ã€‚å¯¹äºé‡å¤§æ›´æ”¹ï¼Œè¯·å…ˆå¼€issueè®¨è®ºæ‚¨æƒ³æ›´æ”¹çš„å†…å®¹ã€‚

---

kunpocc-escä¸ºCocos Creatoræ¸¸æˆå¼€å‘è€…æä¾›äº†ä¸€ä¸ªé«˜æ€§èƒ½ã€æ˜“ç”¨çš„ECSè§£å†³æ–¹æ¡ˆï¼Œè®©å¤æ‚çš„æ¸¸æˆé€»è¾‘å˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚